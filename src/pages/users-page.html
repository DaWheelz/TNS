<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/brum-global-variable/brum-global-variable.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="../../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../../bower_components/paper-datatable-api/paper-datatable-api.html">
<link rel="import" href="../../bower_components/paper-datatable-api/paper-datatable-api-column.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/vaadin-dialog/vaadin-dialog.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">

<dom-module id="users-page">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        padding: 10px;
      }
      .center {
        text-align: center;
      }

      .dialog {
        width:80vh;
      }

      .pull-right {
        float: right;
      }

      paper-button.confirm {
        background-color: #28A745;
        color:white;
      }

      paper-button.dismiss {
        color:#ff0033;
      }
    </style>
    <brum-global-variable key="successtoast" value="{{succesToast}}"></brum-global-variable>
    <brum-global-variable key="errortoast" value="{{errorToast}}"></brum-global-variable>
    <brum-global-variable key="loggedin" value="{{loggedIn}}"></brum-global-variable>
    <brum-global-variable key="language" value="{{language}}"></brum-global-variable>
    <brum-global-variable key="page" value="{{page}}"></brum-global-variable>

    <app-localstorage-document key="userdata" data="{{userdata}}"></app-localstorage-document>

    <iron-ajax id="getallusers" url="/backend/api/users" handle-as="json" on-response="handleResponse" on-error="handleError"
      loading="{{isLoading}}" headers="[[userParams(userdata)]]" method="POST" with-credentials content-type="application/json"></iron-ajax>

    <div class="card">
      <h1>{{localize('users')}}</h1>
      <template is="dom-if" if="[[isLoading]]">
        <div class="center">
            <paper-spinner-lite active></paper-spinner-lite>
        </div>
      </template>
      
      <template is="dom-if" if="[[hasChanged]]" restamp="true">
          <paper-datatable-api data="[[users]]">
              <paper-datatable-api-column header="{{localize('username')}}" property="Username" >
                <template>
                  <span>{{value}}</span>
                </template>
              </paper-datatable-api-column>
              <paper-datatable-api-column header="{{localize('access_level')}}" property="AccessLevel">
                <template>
                  <span>{{value}}</span>
                </template>
              </paper-datatable-api-column>
              <paper-datatable-api-column header="{{localize('enabled')}}" property="IsActive">
                  <template>
                    <span>{{isActive(value)}}</span>
                  </template>
                </paper-datatable-api-column>
                <paper-datatable-api-column header="{{localize('last_login')}}" property="LastLogin">
                    <template>
                      <span>{{value}}</span>
                    </template>
                  </paper-datatable-api-column>
              <paper-datatable-api-column header="{{localize('edit')}}" property="Id">
                  <template>
                    <paper-icon-button icon="editor:mode-edit" on-tap="onEdit" user-id$="[[value]]"></paper-icon-button>
                  </template>
              </paper-datatable-api-column>
            </paper-datatable-api>

        <vaadin-dialog id="editUserDialog" no-close-on-outside-click>
          <template>
            <div class="dialog">
                <paper-input label="{{localize('username')}}" disabled value="{{selectedUser.Username}}"></paper-input>
                <paper-input label="{{localize('new_password')}}" value="{{selectedUser.Password}}" type="password"></paper-input>
                <paper-dropdown-menu label="{{localize('access_level')}}" value="{{selectedUser.AccessLevel}}">
                    <paper-listbox slot="dropdown-content">
                      <paper-item value="Default">Default</paper-item>
                      <paper-item value="Admin">Admin</paper-item>
                    </paper-listbox>
                </paper-dropdown-menu>
                <br>                
                <paper-checkbox checked="{{selectedUser.IsActive}}">{{localize('enabled')}}</paper-checkbox>
                <br>
                <br>
                <paper-button on-tap="onSave" class="confirm">{{localize('save')}}</paper-button>
                <paper-button on-tap="onCancel" class="pull-right dismiss">{{localize('cancel')}}</paper-button>
            </div>
          </template>
        </vaadin-dialog>
      </template>
    </div>
  </template>

  <script>
    class UsersPage extends Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior], Polymer.Element) {
      static get is() { return 'users-page'; }
      static get properties() {
        return {
          isLoading: {
            type: Boolean,
            value: true
          },
          succesToast: String,
          errorToast: String,
          userdata: String,
          users: Array,
          hasChanged: {
            type: Boolean,
            value: true
          },
          language: {
            type: String,
            observer: '_hasLanguageChanged'
          },
          page: {
            type: String,
            observer: '_onPageChanged'
          },
          selectedUser: {
            value: null,
            type: Object
          }
        };
      }

      connectedCallback() {
        super.connectedCallback();
        this.loadResources(this.resolveUrl('../../locales.json'));
      }

      userParams(userdata) {
        if(Object.keys(userdata).length == 0) {
          return;
        }

        var user = JSON.parse(userdata);
        var requestBody = {
          Username: user.username,
          Token: user.accesstoken
        };

        return requestBody;
      }

      handleResponse(data, request) {
        this.users = request.response;
      }

      handleError(data, request) {
        
      }

      isActive(value) {
        if(value) {
          return this.localize('yes');
        } else {
          return this.localize('no');
        }
      }

      onEdit(event) {
        var selectedId = event.target.getAttribute('user-id');
        // Deepclone...
        this.selectedUser = JSON.parse(JSON.stringify(this.users.find(x => x.Id == selectedId)));
        console.log(this.selectedUser);
        this.$$('#editUserDialog').opened = true;
      }

      onSave() {
        this.$$('#editUserDialog').opened = false;
        console.log(this.selectedUser);
      }

      onCancel() {
        this.$$('#editUserDialog').opened = false;
      }

      accesslevelToNumber(accessLevel) {
        if(accessLevel == "Admin") {
          return 1;
        }
        return 0;
      }

      _hasLanguageChanged() {
        // Doing this so table gets rebuild.. Kinda hacky but hey, it works!
        this.hasChanged = false;
        var that = this;
        this.isLoading = true;
        setTimeout(function(){ that.isLoading=false; that.hasChanged = true; }, 300);
      }

      _onPageChanged() {
        if(this.page == "users") {
          this.$.getallusers.generateRequest(); 
        }
      }
    }

    window.customElements.define(UsersPage.is, UsersPage);
  </script>
</dom-module>