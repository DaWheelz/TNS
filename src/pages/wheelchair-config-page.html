<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/brum-global-variable/brum-global-variable.html">
<link rel="import" href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="../../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/vaadin-dialog/vaadin-dialog.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-collapse-item/paper-collapse-item.html">
<link rel="import" href="../../bower_components/paper-collapse-item/paper-collapse-group.html">
<link rel="import" href="../../bower_components/l2t-paper-color/l2t-paper-color.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner-lite.html">
<script src="../../node_modules/three/build/three.min.js"></script>
<script src="../../node_modules/three/build/three.js"></script>

<dom-module id="wheelchair-config-page">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        padding: 10px;
      }

      .center {
        text-align: center;
      }

      .dialog {
        width: 80vh;
      }

      .pull-right {
        float: right;
      }

      paper-button.preview {
        background-color: rgb(31, 121, 224);
        color: white;
      }

      paper-button.confirm {
        background-color: #28A745;
        color: white;
      }

      paper-button.dismiss {
        color: #ff0033;
      }

      paper-radio-button {
        padding: 0;
      }

      paper-checkbox {
        padding: 0;
      }

      .collapsebox {
        width: 60%;
        float: right;
        align-content: flex-end;
        margin-right: 20px;
        padding: 5px;
      }

      .inner {
        position: absolute;
      }

      @media only screen and (max-width: 1170px) {
        .card {
          flex-direction: column;
        }
        .input {
          width: 100%;
          float: left;
        }
        .collapsebox {
          width: 100%;
        }
        .wheelchairDimImg {
          width: 100%;
        }
      }

      .card {
        margin: 24px;
        padding: 16px;
        color: #757575;
        border-radius: 5px;
        background-color: #fff;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
        -webkit-column-count: 3;
        -moz-column-count: 3;
        column-count: 3;
        column-gap: 10px;
        display: flex;
      }
    </style>
    <brum-global-variable key="successtoast" value="{{succesToast}}"></brum-global-variable>
    <brum-global-variable key="errortoast" value="{{errorToast}}"></brum-global-variable>
    <brum-global-variable key="loggedin" value="{{loggedIn}}"></brum-global-variable>
    <brum-global-variable key="language" value="{{language}}"></brum-global-variable>
    <brum-global-variable key="page" value="{{page}}"></brum-global-variable>
    <brum-global-variable key="wheelchairid" value="{{wheelchairId}}"></brum-global-variable>
    <brum-global-variable key="customerid" value="{{customerId}}"></brum-global-variable>

    <app-localstorage-document key="userdata" data="{{userdata}}"></app-localstorage-document>

    <iron-ajax id="getArticles" url="/backend/api/wheelchair/products" handle-as="json" on-error="handleError" on-response="handleResponse"

      headers="[[userParams(userdata)]]" loading="{{isLoading}}">
    </iron-ajax>
    <iron-ajax id="getwheelchair" url="/backend/api/wheelchair/{{wheelchairId}}" handle-as="json" on-error="handleGetError" on-response="handleGetResponse"
      headers="[[userParams(userdata)]]" loading="{{isLoading}}">
    </iron-ajax>
    <iron-ajax id="saveWheelchairs" url="/backend/api/wheelchair" handle-as="json" on-response="onSaveResponse" on-error="onSaveError"
      loading="{{isLoading}}" headers="[[userParams(userdata)]]" method="POST" with-credentials content-type="application/json"></iron-ajax>

    <vaadin-dialog id="addNotesDialog" no-close-on-outside-click>
      <template>
        <div class="dialog">
          <h1>{{localize('add_addition')}} ({{selectedArticle.Description}})</h1>
          <paper-textarea label="{{localize('comment')}}" value="{{addition.Comment}}"></paper-textarea>
          <paper-input label="{{localize('discount')}}" value="{{addition.Discount}}" type="number"></paper-input>
          <paper-input label="{{localize('amount')}}" value="{{addition.Amount}}" type="number"></paper-input>
          <br>
          <paper-button on-tap="onCancel" class="pull-right dismiss">{{localize('cancel')}}</paper-button>
          <paper-button on-tap="onSaveNotes" class="confirm">{{localize('save')}}</paper-button>
          <br>
        </div>
      </template>
    </vaadin-dialog>

    <vaadin-dialog id="loadingDialog" no-close-on-esc no-close-on-outside-click>
      <template>
        <div style="text-align: center;">
          {{localize('loading')}}...
          <br>
          <paper-spinner-lite active></paper-spinner-lite>
        </div>
      </template>
    </vaadin-dialog>

    <div class="card">
      <!-- left side -->
      <div>
        <!-- webGL -->
        <div id="renderCanvas" style="background-color: white"></div>
        <div style="column-count: 3; margin-bottom: 20px;">
          <paper-input id="SeatWidth" label="{{localize('seat_width')}}" value="{{newWheelchair.SeatWidth}}" type="number"></paper-input>
          <paper-input id="FootplateWidth" label="{{localize('footplate_width')}}" value="{{newWheelchair.FootplateWidth}}" type="number"></paper-input>
          <paper-input id="SeatDepth" label="{{localize('seat_depth')}}" value="{{newWheelchair.SeatDepth}}" type="number"></paper-input>
          <paper-input id="FrameLength" label="{{localize('frame_length')}}" value="{{newWheelchair.FrameLength}}" type="number"></paper-input>
          <paper-input id="BackrestHeight" label="{{localize('backrest_height')}}" value="{{newWheelchair.BackrestHeight}}" type="number"></paper-input>
          <paper-input id="SeatheightFront" label="{{localize('seat_height_front')}}" value="{{newWheelchair.SeatHeightFront}}" type="number"></paper-input>
          <paper-input id="SeatheightBack" label="{{localize('seat_height_back')}}" value="{{newWheelchair.SeatHeightBack}}" type="number"></paper-input>
          <paper-input id="BalancePoint" label="{{localize('balance_point')}}" value="{{newWheelchair.BalancePoint}}" type="number"></paper-input>
          <paper-input id="LowerLegWidth" label="{{localize('lowerleg_width')}}" value="{{newWheelchair.LowerLegWidth}}" type="number"></paper-input>
        </div>
        <paper-button class="cancel" style="float:left">{{localize('cancel')}}</paper-button>
        <paper-button class="confirm" style="float:right" on-tap="onSave">{{localize('save')}}</paper-button>
        <paper-button class="preview" on-tap="showWheelchairPreviewDialog" style="float:right">{{localize('preview')}}</paper-button>
      </div>
      <!-- right side -->
      <div class="collapsebox">
        <paper-collapse-item id="articles" class="styled" header="{{localize('articles')}}">
          <br>
          <template is="dom-repeat" id="articleList" items="{{articles}}">
            <paper-checkbox on-tap="toggleSelection" selectedArticle$="[[index]]" checked="{{isArticleChecked(item, newWheelchair.Articles)}}">[[item.Description]]
              <b>€[[item.Price]]</b>
            </paper-checkbox>
            <paper-icon-button icon="editor:mode-edit" product$="[[item]]" on-tap="addArticleNote"></paper-icon-button>
            <br/>
          </template>
          <!-- gets all selected checkboxes and put it in a list -->
          <!-- <array-selector id="arraySelector" items="{{articles}}" selected="{{newWheelchair.Articles}}" multi toggle></array-selector> -->
        </paper-collapse-item>

        <paper-collapse-item id="frontwheels" header="{{localize('frontwheels')}}">
          <paper-radio-group>
            <template is="dom-repeat" items="[[frontwheels]]">
              <paper-radio-button selectedFrontwheels$="[[index]]" name="{{item.Description}}" on-tap="frontWheelsCollapse" checked="{{isFrontwheelChecked(item, newWheelchair.Frontwheels)}}">[[item.Description]]
                <b>€[[item.Price]]</b>
              </paper-radio-button>
              <paper-icon-button icon="editor:mode-edit" product$="[[item]]" selectedFrontwheels$="[[index]]" on-tap="addFrontwheelNote"></paper-icon-button>
              <br/>
            </template>
          </paper-radio-group>
        </paper-collapse-item>

        <paper-collapse-item id="hoops" header="{{localize('hoops')}}">
          <paper-radio-group>
            <template is="dom-repeat" items="[[hoops]]">
              <paper-radio-button selectedHoops$="[[index]]" name="{{item.Description}}" on-tap="hoopsCollapse" checked="{{isHoopChecked(item, newWheelchair.Hoops)}}">[[item.Description]]
                <b>€[[item.Price]]</b>
              </paper-radio-button>
              <paper-icon-button icon="editor:mode-edit" product$="[[item]]" selectedHoops$="[[index]]" on-tap="addHoopNote"></paper-icon-button>
              <br />
            </template>
          </paper-radio-group>
        </paper-collapse-item>

        <paper-collapse-item id="wheels" header="{{localize('wheels')}}">
          <paper-radio-group>
            <template is="dom-repeat" items="[[wheels]]">
              <paper-radio-button selectedWheels$="[[index]]" name="{{item.Description}}" on-tap="wheelsCollapse" checked="{{isWheelChecked(item, newWheelchair.Wheels)}}">[[item.Description]]
                <b>€[[item.Price]]</b>
              </paper-radio-button>
              <paper-icon-button icon="editor:mode-edit" product$="[[item]]" selectedWheels$="[[index]]" on-tap="addWheelNote"></paper-icon-button>
              <br />
            </template>
          </paper-radio-group>
        </paper-collapse-item>

        <paper-collapse-item id="tires" header="{{localize('tires')}}">
          <paper-radio-group>
            <template is="dom-repeat" items="[[tires]]">
              <paper-radio-button selectedTires$="[[index]]" name="{{item.Description}}" on-tap="tiresCollapse" checked="{{isTireChecked(item, newWheelchair.Tires)}}">[[item.Description]]
                <b>€[[item.Price]]</b>
              </paper-radio-button>
              <paper-icon-button icon="editor:mode-edit" product$="[[item]]" selectedTires$="[[index]]" on-tap="addTireNote"></paper-icon-button>
              <br/>
            </template>
          </paper-radio-group>
        </paper-collapse-item>

        <paper-collapse-item id="wheelprotectors" header="{{localize('wheel_protectors')}}">
          <paper-radio-group>
            <template is="dom-repeat" items="[[wheelprotectors]]">
              <paper-radio-button selectedWheelprotectors$="[[index]]" name="{{item.Description}}" on-tap="wheelProtectorsCollapse" checked="{{isWheelprotectorChecked(item, newWheelchair.Wheelprotectors)}}">[[item.Description]]
                <b>€[[item.Price]]</b>
              </paper-radio-button>
              <paper-icon-button icon="editor:mode-edit" product$="[[item]]" selectedWheelprotectors$="[[index]]" on-tap="addWheelprotectorNote"></paper-icon-button>
              <br/>
            </template>
          </paper-radio-group>
        </paper-collapse-item>

        <paper-collapse-item id="wheelchaircolor" header="{{localize('color')}}">
          <l2t-paper-color value="{{wheelchairColor}}" colors='{{ralColorCodes}}' hide-advanced></l2t-paper-color>
        </paper-collapse-item>
      </div>
    </div>
  </template>

  <script>
    class WheelchairConfigPage extends Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior], Polymer.Element) {
      static get is() {
        return 'wheelchair-config-page';
      }
      static get properties() {
        return {
          language: {
            type: String
          },
          articles: {
            type: Array
          },
          wheels: {
            type: Array
          },
          frontwheels: {
            type: Array
          },
          hoops: {
            type: Array
          },
          tires: {
            type: Array
          },
          wheelprotector: {
            type: Array
          },
          ralcolors: {
            type: Array
          },
          ralColorCodes: {
            type: Array
          },
          newWheelchair: {
            value: {
              Addition: [],
              Articles: [],
              Frontwheels: [],
              Hoops: [],
              Wheels: [],
              Tires: [],
              Wheelprotectors: [],
              Color: {}
            },
            type: Object
          },
          selectedArticle: {
            value: {},
            type: Object
          },
          addition: {
            value: {},
            type: Object
          },
          wheelchairColor: {
            value: "#F5FF00",
            observer: 'onWheelchairColorChanged'
          },
          userdata: {
            type: String

          },
          page: {
            type: String,
            observer: '_onPageChanged'
          },
          isLoading: {
            observer: "_onLoadingChanged"
          }
        };
      }
      connectedCallback() {
        super.connectedCallback();
        this.loadResources(this.resolveUrl('../../locales.json'));
      }

      isArticleChecked(article, selectedArticles) {
        var shouldChecked = false;
        selectedArticles.forEach(selected => {
          if (selected.ArticleId == article.ArticleId) {
            shouldChecked = true;
          }
        });
        return shouldChecked;
        
      showWheelchairPreviewDialog() {
        //gets div element
        var div = this.$$('#renderCanvas');

        //generates canvas in code, because Polymer doesn't support it at this point
        var mycanvas = document.createElement("canvas");
        mycanvas.id = "mycanvas";
        // div.appendChild(mycanvas);

        //renderer
        var renderer = new THREE.WebGLRenderer({
          alpha: true
        });
        renderer.setSize(600, 334);

        //add canvas to div element
        div.appendChild(renderer.domElement);

        //camera
        var camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 500);
        camera.position.set(0,
          0, 100);
        camera.lookAt(new THREE.Vector3(0, 0, 0));

        var material = new THREE.LineBasicMaterial({
          color: 0x000000,
        });

        var scene = new THREE.Scene();

        //initializing all geometries
        var backrestfrontview = new THREE.Geometry();
        var backrestfrontview2 = new THREE.Geometry();
        var wheelaxispipe = new THREE.Geometry();
        var seatheightfrontview = new THREE.Geometry();
        var footplate = new THREE.Geometry();
        var seatbar = new THREE.Geometry();

        var lowerleg1 = new THREE.Geometry();
        var lowerleg2 = new THREE.Geometry();
        var lowerleg3 = new THREE.Geometry();
        var lowerleg4 = new THREE.Geometry();
        var wheelpiece = new THREE.Geometry();
        var wheelpieceupper = new THREE.Geometry();
        var seatdepth1 = new THREE.Geometry();
        var seatdepth2 = new THREE.Geometry();
        var cushion = new THREE.Geometry();
        var seatheight1 = new THREE.Geometry();
        var seatheight2 = new THREE.Geometry();
        var seatheight3 = new THREE.Geometry();

        //frontview
        backrestfrontview.vertices.push(new THREE.Vector3(-70, 15, 0));
        backrestfrontview.vertices.push(new THREE.Vector3(-70, -22, 0));
        backrestfrontview.vertices.push(new THREE.Vector3(-67, -22, 0));
        backrestfrontview.vertices.push(new THREE.Vector3(-67, 15, 0));
        backrestfrontview.vertices.push(new THREE.Vector3(-70, 15, 0));

        backrestfrontview2.vertices.push(new THREE.Vector3(-40, -22, 0));
        backrestfrontview2.vertices.push(new THREE.Vector3(-40, 15, 0));
        backrestfrontview2.vertices.push(new THREE.Vector3(-37, 15, 0));
        backrestfrontview2.vertices.push(new THREE.Vector3(-37, -22, 0));
        backrestfrontview2.vertices.push(new THREE.Vector3(-40, -22, 0));

        wheelaxispipe.vertices.push(new THREE.Vector3(-40, -17, 0));
        wheelaxispipe.vertices.push(new THREE.Vector3(-54, -18, 0));
        wheelaxispipe.vertices.push(new THREE.Vector3(-67, -17, 0));
        wheelaxispipe.vertices.push(new THREE.Vector3(-67, -19, 0));
        wheelaxispipe.vertices.push(new THREE.Vector3(-54, -20, 0));
        wheelaxispipe.vertices.push(new THREE.Vector3(-40, -19, 0));
        wheelaxispipe.vertices.push(new THREE.Vector3(-40, -17, 0));

        seatheightfrontview.vertices.push(new THREE.Vector3(-67, 10, 0));
        seatheightfrontview.vertices.push(new THREE.Vector3(-40, 10, 0));
        seatheightfrontview.vertices.push(new THREE.Vector3(-40, 8, 0));
        seatheightfrontview.vertices.push(new THREE.Vector3(-67, 8, 0));

        footplate.vertices.push(new THREE.Vector3(-65, -35, 0));
        footplate.vertices.push(new THREE.Vector3(-43, -35, 0));

        seatbar.vertices.push(new THREE.Vector3(-67, -8, 0));
        seatbar.vertices.push(new THREE.Vector3(-60, -12, 0));
        seatbar.vertices.push(new THREE.Vector3(-48, -12, 0));
        seatbar.vertices.push(new THREE.Vector3(-40, -8, 0));
        seatbar.vertices.push(new THREE.Vector3(-40, -6, 0));
        seatbar.vertices.push(new THREE.Vector3(-48, -10, 0));
        seatbar.vertices.push(new THREE.Vector3(-60, -10, 0));
        seatbar.vertices.push(new THREE.Vector3(-67, -8, 0));


        //sideview
        //lowerLeg framelength                     X   Y   Z
        lowerleg1.vertices.push(new THREE.Vector3(12, -20, 0));
        lowerleg1.vertices.push(new THREE.Vector3(10, -30, 0));
        lowerleg1.vertices.push(new THREE.Vector3(13, -30, 0));

        lowerleg2.vertices.push(new THREE.Vector3(15, -20, 0));
        lowerleg2.vertices.push(new THREE.Vector3(13, -30, 0));

        //connection to seatdepth (curve)
        lowerleg3.vertices.push(new THREE.Vector3(12, -20, 0));
        lowerleg3.vertices.push(new THREE.Vector3(15, -12, 0));
        lowerleg3.vertices.push(new THREE.Vector3(18, -8, 0));
        lowerleg3.vertices.push(new THREE.Vector3(25, -7, 0));

        lowerleg4.vertices.push(new THREE.Vector3(15, -20, 0));
        lowerleg4.vertices.push(new THREE.Vector3(16, -17, 0));
        lowerleg4.vertices.push(new THREE.Vector3(19, -12, 0));
        lowerleg4.vertices.push(new THREE.Vector3(21, -11, 0));
        lowerleg4.vertices.push(new THREE.Vector3(25, -10, 0));

        wheelpiece.vertices.push(new THREE.Vector3(21, -35, 0));
        wheelpiece.vertices.push(new THREE.Vector3(17, -28, 0));
        wheelpiece.vertices.push(new THREE.Vector3(20, -28, 0));
        wheelpiece.vertices.push(new THREE.Vector3(21, -35, 0));

        wheelpieceupper.vertices.push(new THREE.Vector3(20, -28, 0));
        wheelpieceupper.vertices.push(new THREE.Vector3(20, -21, 0));
        wheelpieceupper.vertices.push(new THREE.Vector3(17, -21, 0));
        wheelpieceupper.vertices.push(new THREE.Vector3(17, -28, 0));
        wheelpieceupper.vertices.push(new THREE.Vector3(17, -22, 0));
        wheelpieceupper.vertices.push(new THREE.Vector3(13, -20, 0));
        wheelpieceupper.vertices.push(new THREE.Vector3(12, -24, 0));
        wheelpieceupper.vertices.push(new THREE.Vector3(17, -26, 0));

        //seatdepth
        seatdepth1.vertices.push(new THREE.Vector3(25, -10, 0));
        seatdepth1.vertices.push(new THREE.Vector3(63, -10, 0));

        seatdepth2.vertices.push(new THREE.Vector3(25, -7, 0));
        seatdepth2.vertices.push(new THREE.Vector3(60, -7, 0));

        cushion.vertices.push(new THREE.Vector3(60, -3, 0));
        cushion.vertices.push(new THREE.Vector3(25, -3, 0));
        cushion.vertices.push(new THREE.Vector3(24, -4, 0));
        cushion.vertices.push(new THREE.Vector3(23.3, -5.5, 0));
        cushion.vertices.push(new THREE.Vector3(24, -6.8, 0));
        cushion.vertices.push(new THREE.Vector3(25, -7, 0));

        //backseatheight
        seatheight1.vertices.push(new THREE.Vector3(60, -10, 0));
        seatheight1.vertices.push(new THREE.Vector3(60, 15, 0));

        seatheight2.vertices.push(new THREE.Vector3(63, -10, 0));
        seatheight2.vertices.push(new THREE.Vector3(63, 15, 0));
        seatheight2.vertices.push(new THREE.Vector3(63, 5, 0));
        seatheight2.vertices.push(new THREE.Vector3(70, 5, 0));
        seatheight2.vertices.push(new THREE.Vector3(71, 6, 0));
        seatheight2.vertices.push(new THREE.Vector3(70, 7, 0));
        seatheight2.vertices.push(new THREE.Vector3(63, 7, 0));

        seatheight3.vertices.push(new THREE.Vector3(60, 15, 0));
        seatheight3.vertices.push(new THREE.Vector3(63, 15, 0));

        //wheels                            X    Y  (Radius) (   angles   )         rotation
        var wheel1 = new THREE.EllipseCurve(54, -18, 25, 21, 0, 2 * Math.PI, false, 0);
        var points = wheel1.getPoints(50);
        var wheelbuffer1 = new THREE.BufferGeometry().setFromPoints(points);

        var wheel2 = new THREE.EllipseCurve(54, -18, 22, 18, 0, 2 * Math.PI, false, 0);
        var points = wheel2.getPoints(50);
        var wheelbuffer2 = new THREE.BufferGeometry().setFromPoints(points);

        var wheelaxis = new THREE.EllipseCurve(54, -18, 3, 2.5, 0, 2 * Math.PI, false, 0);
        var points = wheelaxis.getPoints(50);
        var wheelaxisbuffer = new THREE.BufferGeometry().setFromPoints(points);

        var frontwheel = new THREE.EllipseCurve(21, -35, 6, 5, 0, 2 * Math.PI, false, 0);
        var points = frontwheel.getPoints(50);
        var frontwheelbuffer = new THREE.BufferGeometry().setFromPoints(points);

        // Create the final object to add to the scene
        var backrestfrontviewline = new THREE.Line(backrestfrontview, material);
        var backrestfrontviewline2 = new THREE.Line(backrestfrontview2, material);
        var wheelaxislinefrontview = new THREE.Line(wheelaxispipe, material);
        var seatheightfrontviewline = new THREE.Line(seatheightfrontview, material);
        var footlplateline = new THREE.Line(footplate, material);
        var seatbarline = new THREE.Line(seatbar, material);

        var lowerlegline1 = new THREE.Line(lowerleg1, material);
        var lowerlegline2 = new THREE.Line(lowerleg2, material);
        var lowerlegline3 = new THREE.Line(lowerleg3, material);
        var lowerlegline4 = new THREE.Line(lowerleg4, material);

        var seatdepthline1 = new THREE.Line(seatdepth1, material);
        var seatdepthline2 = new THREE.Line(seatdepth2, material);
        var cushionline = new THREE.Line(cushion, material);

        var seatheightline1 = new THREE.Line(seatheight1, material);
        var seatheightline2 = new THREE.Line(seatheight2, material);
        var seatheightline3 = new THREE.Line(seatheight3, material);

        var wheelline1 = new THREE.Line(wheelbuffer1, material);
        var wheelline2 = new THREE.Line(wheelbuffer2, material);
        var wheelaxisline = new THREE.Line(wheelaxisbuffer, material);
        var frontwheelline = new THREE.Line(frontwheelbuffer, material);
        var wheelpieceline = new THREE.Line(wheelpiece, material);
        var wheelpieceupperline = new THREE.Line(wheelpieceupper, material);


        //add everything to the scene
        scene.add(backrestfrontviewline);
        scene.add(backrestfrontviewline2);
        scene.add(wheelaxislinefrontview);
        scene.add(seatheightfrontviewline);
        scene.add(footlplateline);
        scene.add(seatbarline);

        scene.add(lowerlegline1);
        scene.add(lowerlegline2);
        scene.add(lowerlegline3);
        scene.add(lowerlegline4);
        scene.add(seatdepthline1);
        scene.add(seatdepthline2);
        scene.add(cushionline);
        scene.add(seatheightline1);
        scene.add(seatheightline2);
        scene.add(seatheightline3);
        scene.add(wheelline1);
        scene.add(wheelline2);
        scene.add(wheelaxisline);
        scene.add(frontwheelline);
        scene.add(wheelpieceline);
        scene.add(wheelpieceupperline);

        //renders scene to the WebGLRenderer
        renderer.render(scene, camera);

      }
      _hasLanguageChanged() {
        this.hasChanged = false;
        var that = this;
        this.isLoading = true;
        setTimeout(function () {
          that.isLoading = false;
          that.hasChanged = true;
        }, 300);
      }

      isFrontwheelChecked(frontwheel, selectedFrontwheels) {
        var shouldChecked = false;
        selectedFrontwheels.forEach(selected => {
          if (selected.FrontWheelId == frontwheel.FrontWheelId) {
            shouldChecked = true;
          }
        });
        return shouldChecked;
      }

      isHoopChecked(hoop, selectedHoops) {
        var shouldChecked = false;
        selectedHoops.forEach(selected => {
          if (selected.HoopId == hoop.HoopId) {
            shouldChecked = true;
          }
        });
        return shouldChecked;
      }

      isWheelChecked(wheel, selectedWheels) {
        var shouldChecked = false;
        selectedWheels.forEach(selected => {
          if (selected.WheelId == wheel.WheelId) {
            shouldChecked = true;
          }
        });
        return shouldChecked;
      }

      isTireChecked(tire, selectedTires) {
        var shouldChecked = false;
        selectedTires.forEach(selected => {
          if (selected.TireId == tire.TireId) {
            shouldChecked = true;
          }
        });
        return shouldChecked;
      }


      isWheelprotectorChecked(wheelprotector, selectedWheelprotector) {
        var shouldChecked = false;
        selectedWheelprotector.forEach(selected => {
          if (selected.WheelprotectorId == wheelprotector.WheelprotectorId) {
            shouldChecked = true;
          }
        });
        return shouldChecked;
      }

      handleResponse(data, request) {
        this.articles = request.response.Articles;
        this.wheels = request.response.Wheel;
        this.frontwheels = request.response.FrontWheels;
        this.hoops = request.response.Hoops;
        this.tires = request.response.Tires;
        this.wheelprotectors = request.response.WheelProtector;
        this._convertToBackendObjects();

        this.ralcolors = request.response.RalColors;
        this.ralColorCodes = [];
        var that = this;
        this.ralcolors.forEach(function (color) {
          that.ralColorCodes.push(color.HexColorCode);
        });
      }
      onCancel() {
        this.$$('#addNotesDialog').opened = false;
      }

      onSaveNotes() {
        var that = this;
        if (this.selectedArticle.Type == "Article") {
          this._saveArticleNote();
        } else if (this.selectedArticle.Type == "Wheelprotector") {
          this._saveWheelprotectorNote();
        } else if (this.selectedArticle.Type == "Tire") {
          this._saveTireNote();
        } else if (this.selectedArticle.Type == "Frontwheel") {
          this._saveFrontwheelNote();
        } else if (this.selectedArticle.Type == "Hoop") {
          this._saveHoopNote();
        } else if (this.selectedArticle.Type == "Wheel") {
          this._saveWheelNote();
        } else {
          this.newWheelchair.Addition = this.Addition;
        }
        this.$$('#addNotesDialog').opened = false;
      }

      onSaveError(event) {
        this.errorToast = event.detail.request.xhr.statusText;
      }

      handleError(response, data) {
        if (data.request.status == 403) {
          this.errorToast = this.localize('access_denied', 'error', data.request.response);
          this.userdata = "{}";
          this.loggedIn = false;
        } else {
          this.errorToast = this.localize('unknown_error', 'error', data.request.response);
        }
      }

      onSave() {
        this.$$('#saveWheelchairs').body = JSON.stringify(this.newWheelchair);
        this.$$('#saveWheelchairs').generateRequest();
      }

      toggleSelection(event) {
        var index = event.target.attributes.getNamedItem('selectedArticle').value
        console.log("index:", index);
        if (this.isArticleChecked(this.articles[index], this.newWheelchair.Articles)) {
          console.log("Exists, removing...");
          for (var i = this.newWheelchair.Articles.length - 1; i >= 0; --i) {
            if (this.newWheelchair.Articles[i].ArticleId == this.articles[index].ArticleId) {
              console.log("Found match!", this.newWheelchair.Articles[i], this.articles[index]);
              this.newWheelchair.Articles.splice(i, 1);
            }
          }
        } else {
          console.log("Does not exist, adding...");
          this.newWheelchair.Articles.push(this.articles[index]);
        }
        if (this.newWheelchair.Articles.length == 1) {
          this.$.articles.header =
            `${this.localize('articles')} : <u style='color:green'> 1 ${this.localize('article')} ${this.localize('selected')}</u>`;
        } else {
          this.$.articles.header =
            `${this.localize('articles')} : <u style='color:green'> ${this.newWheelchair.Articles.length} ${this.localize('articles')} ${this.localize('selected')}</u>`;
        }
      }

      frontWheelsCollapse(event) {
        this.$.frontwheels._toggleOpened(null);
        var index = event.target.attributes.getNamedItem('selectedFrontwheels').value;
        this.newWheelchair.Frontwheels = [];
        this.newWheelchair.Frontwheels.push(this.frontwheels[index]);
        this.notifyPath('newWheelchair.Frontwheels');
        this.$.frontwheels.header =
          `${this.localize('frontwheels')} : <u style='color:green'> ${this.newWheelchair.Frontwheels[0].Description}`;
      }

      hoopsCollapse(event) {
        this.$.hoops._toggleOpened(null);
        var index = event.target.attributes.getNamedItem('selectedHoops').value;
        this.newWheelchair.Hoops = [];
        this.newWheelchair.Hoops.push(this.hoops[index]);
        this.notifyPath('newWheelchair.Hoops');
        this.$.hoops.header =
          `${this.localize('hoops')} : <u style='color:green'> ${this.newWheelchair.Hoops[0].Description}`;
      }

      wheelsCollapse(event) {
        this.$.wheels._toggleOpened(null);
        var index = event.target.attributes.getNamedItem('selectedWheels').value;
        this.newWheelchair.Wheels = [];
        this.newWheelchair.Wheels.push(this.wheels[index]);
        this.notifyPath('newWheelchair.Wheels');
        this.$.wheels.header =
          `${this.localize('wheels')} : <u style='color:green'> ${this.newWheelchair.Wheels[0].Description}`;
      }

      tiresCollapse(event) {
        this.$.tires._toggleOpened(null);
        var index = event.target.attributes.getNamedItem('selectedTires').value;
        this.newWheelchair.Tires = [];
        this.newWheelchair.Tires.push(this.tires[index]);
        this.notifyPath('newWheelchair.Tires');
        this.$.tires.header =
          `${this.localize('tires')} : <u style='color:green'> ${this.newWheelchair.Tires[0].Description}`;
      }

      wheelProtectorsCollapse(event) {
        this.$.wheelprotectors._toggleOpened(null);
        var index = event.target.attributes.getNamedItem('selectedWheelprotectors').value;
        this.newWheelchair.Wheelprotectors = [];
        this.newWheelchair.Wheelprotectors.push(this.wheelprotectors[index]);
        this.notifyPath('newWheelchair.Wheelprotectors');
        this.$.wheelprotectors.header =
          `${this.localize('wheel_protectors')} : <u style='color:green'> ${this.newWheelchair.Wheelprotectors[0].Description}`;
      }

      onWheelchairColorChanged(colorCode) {
        if (this.ralcolors) {
          var color = this.ralcolors.filter(function (color) {
            return color.HexColorCode == colorCode;
          });
          this.newWheelchair.Color = color[0];
          this.notifyPath('newWheelchair.Color');
          this.$.wheelchaircolor._toggleOpened(null);
          //header dot changes to selected color
          this.$.wheelchaircolor.header =
            `${this.localize('color')} : RAL ${this.newWheelchair.Color.ColorCode}
            <div style='background-color: ${this.newWheelchair.Color.HexColorCode}; width:25px; height:25px; border-radius: 50%; display:inline; float:right; margin-right:20px;'> </div>`;
        }
      }

      onSaveResponse(data, request) {
        this.succesToast = this.localize('save_wheelchair_success');
        this.handleGetResponse(data, request);
      }

      handleGetResponse(data, request) {
        this.newWheelchair = request.response;
        this.newWheelchair.OldId = this.newWheelchair.Id;
        delete this.newWheelchair["Id"];
        this.newWheelchair.Articles.forEach(function (article) {
          article.Id = 0;
        });
        this.newWheelchair.Frontwheels.forEach(function (fwheel) {
          fwheel.Id = 0;
        });
        this.newWheelchair.Hoops.forEach(function (hoop) {
          hoop.Id = 0;
        });
        this.newWheelchair.Tires.forEach(function (tire) {
          tire.Id = 0;
        });
        this.newWheelchair.Wheelprotectors.forEach(function (wp) {
          wp.Id = 0;
        });
        this.newWheelchair.Wheels.forEach(function (wheel) {
          wheel.Id = 0;
        });
        this.wheelchairColor = this.newWheelchair.Color.HexColorCode;
        if (this.newWheelchair.Articles.length == 1) {
          this.$.articles.header =
            `${this.localize('articles')} : <u style='color:green'> 1 ${this.localize('article')} ${this.localize('selected')}</u>`;
        } else {
          this.$.articles.header =
            `${this.localize('articles')} : <u style='color:green'> ${this.newWheelchair.Articles.length} ${this.localize('articles')} ${this.localize('selected')}</u>`;
        }
        this.$.frontwheels.header =
          `${this.localize('frontwheels')} : <u style='color:green'> ${this.newWheelchair.Frontwheels[0].Frontwheel.Description}`;
        this.$.hoops.header =
          `${this.localize('hoops')} : <u style='color:green'> ${this.newWheelchair.Hoops[0].Hoop.Description}`;
        this.$.wheels.header =
          `${this.localize('wheels')} : <u style='color:green'> ${this.newWheelchair.Wheels[0].Wheel.Description}`;
        this.$.tires.header =
          `${this.localize('tires')} : <u style='color:green'> ${this.newWheelchair.Tires[0].Tire.Description}`;
        if (this.newWheelchair.Wheelprotectors) {
          this.$.wheelprotectors.header =
            `${this.localize('wheel_protectors')} : <u style='color:green'> ${this.newWheelchair.Wheelprotectors[0].WheelProtector.Description}`;
        }
      }


      userParams(userdata) {
        if (userdata == null || userdata == "") {
          return null;
        }
        var user = JSON.parse(userdata);
        if (Object.keys(user).length == 0) {
          return null;
        }
        var requestBody = {
          Username: user.username,
          Token: user.accesstoken
        };
        return requestBody;
      }

      addArticleNote(event) {
        var that = this;
        this.addition = {};
        var product = JSON.parse(event.target.getAttribute('product'));
        var containsArticle = false;
        this.newWheelchair.Articles.forEach(function (article) {
          if (article.ArticleId == product.ArticleId) {
            containsArticle = true;
            if (article.Addition) {
              that.addition = article.Addition;
            }
          }
        });

        if (containsArticle) {
          product.Type = "Article";
          this.selectedArticle = product;
          this.$$('#addNotesDialog').opened = true;
        } else {
          this.errorToast = this.localize('add_product_before_note');
        }
      }

      addWheelprotectorNote(event) {
        var that = this;
        this.addition = {};
        var product = JSON.parse(event.target.getAttribute('product'));
        var containsArticle = false;
        this.newWheelchair.Wheelprotectors.forEach(function (protector) {
          if (protector.WheelprotectorId == product.WheelprotectorId) {
            containsArticle = true;
            if (protector.Addition) {
              that.addition = protector.Addition;
            }
          }
        });

        if (containsArticle) {
          product.Type = "Wheelprotector";
          this.selectedArticle = product;
          this.$$('#addNotesDialog').opened = true;
        } else {
          this.errorToast = this.localize('add_product_before_note');
        }
      }

      addFrontwheelNote(event) {
        var that = this;
        this.addition = {};
        var product = JSON.parse(event.target.getAttribute('product'));
        var containsArticle = false;
        this.newWheelchair.Frontwheels.forEach(function (frontwheel) {
          if (frontwheel.FrontWheelId == product.FrontWheelId) {
            containsArticle = true;
            if (frontwheel.Addition) {
              that.addition = frontwheel.Addition;
            }
          }
        });

        if (containsArticle) {
          product.Type = "Frontwheel";
          this.selectedArticle = product;
          this.$$('#addNotesDialog').opened = true;
        } else {
          this.errorToast = this.localize('add_product_before_note');
        }
      }

      addHoopNote(event) {
        var that = this;
        this.addition = {};
        var product = JSON.parse(event.target.getAttribute('product'));
        var containsArticle = false;
        this.newWheelchair.Hoops.forEach(function (hoop) {
          if (hoop.HoopId == product.HoopId) {
            containsArticle = true;
            if (hoop.Addition) {
              that.addition = hoop.Addition;
            }
          }
        });

        if (containsArticle) {
          product.Type = "Hoop";
          this.selectedArticle = product;
          this.$$('#addNotesDialog').opened = true;
        } else {
          this.errorToast = this.localize('add_product_before_note');
        }
      }

      addWheelNote(event) {
        var that = this;
        this.addition = {};
        var product = JSON.parse(event.target.getAttribute('product'));
        var containsArticle = false;
        this.newWheelchair.Wheels.forEach(function (wheel) {
          if (wheel.WheelId == product.WheelId) {
            containsArticle = true;
            if (wheel.Addition) {
              that.addition = wheel.Addition;
            }
          }
        });

        if (containsArticle) {
          product.Type = "Wheel";
          this.selectedArticle = product;
          this.$$('#addNotesDialog').opened = true;
        } else {
          this.errorToast = this.localize('add_product_before_note');
        }
      }

      addTireNote(event) {
        var that = this;
        this.addition = {};
        var product = JSON.parse(event.target.getAttribute('product'));
        var containsArticle = false;
        this.newWheelchair.Tires.forEach(function (tire) {
          if (tire.TireId == product.TireId) {
            containsArticle = true;
            if (tire.Addition) {
              that.addition = tire.Addition;
            }
          }
        });

        if (containsArticle) {
          product.Type = "Tire";
          this.selectedArticle = product;
          this.$$('#addNotesDialog').opened = true;
        } else {
          this.errorToast = this.localize('add_product_before_note');
        }
      }

      _saveArticleNote() {
        var that = this;
        this.newWheelchair.Articles.forEach(function (article) {
          if (article.ArticleId == that.selectedArticle.ArticleId) {
            article.Addition = that.addition;
          }
        });
      }

      _saveWheelprotectorNote() {
        var that = this;
        this.newWheelchair.Wheelprotectors.forEach(function (wheelprotector) {
          if (wheelprotector.WheelprotectorId == that.selectedArticle.WheelprotectorId) {
            wheelprotector.Addition = that.addition;
          }
        });
      }


      _saveFrontwheelNote() {
        var that = this;
        this.newWheelchair.Frontwheels.forEach(function (frontwheel) {
          if (frontwheel.FrontWheelId == that.selectedArticle.FrontWheelId) {
            frontwheel.Addition = that.addition;
          }
        });
      }

      _saveHoopNote() {
        var that = this;
        this.newWheelchair.Hoops.forEach(function (hoop) {
          if (hoop.HoopId == that.selectedArticle.HoopId) {
            hoop.Addition = that.addition;
          }
        });
      }

      _saveWheelNote() {
        var that = this;
        this.newWheelchair.Wheels.forEach(function (wheel) {
          if (wheel.WheelId == that.selectedArticle.WheelId) {
            wheel.Addition = that.addition;
          }
        });
      }

      _saveTireNote() {
        var that = this;
        this.newWheelchair.Tires.forEach(function (tire) {
          if (tire.TireId == that.selectedArticle.TireId) {
            tire.Addition = that.addition;
          }
        });
      }

      _onPageChanged() {
        if (this.page == "wheelchair-config") {
          if (this.userdata != "" && this.userdata != undefined) {
            this.$.getArticles.generateRequest();
            if (this.wheelchairId != 0 && this.wheelchairId != null && this.wheelchairId != undefined) {
              this.$$('#getwheelchair').generateRequest();
            } else if (this.customerId != 0 && this.customerId != null && this.customerId != undefined) {
              this.newWheelchair.CustomerId = this.customerId;
            }
          }
        } else {
          this.newWheelchair = {
            Addition: [],
            Articles: [],
            Frontwheels: [],
            Hoops: [],
            Wheels: [],
            Tires: [],
            Wheelprotectors: [],
            Color: {},
            OldId: 0
          };
          this.customerId = 0;
          this.wheelchairId = 0;
          this.$.frontwheels.header = `${this.localize('frontwheels')}`;
          this.$.hoops.header = `${this.localize('hoops')}`;
          this.$.wheels.header = `${this.localize('wheels')}`;
          this.$.tires.header = `${this.localize('tires')}`;
          this.$.wheelprotectors.header = `${this.localize('wheel_protectors')}`;
          this.$.wheelchaircolor.header = `${this.localize('color')}`;
          this.$.articles.header = `${this.localize('articles')}`;
        }
      }

      _onLoadingChanged(newValue) {
        if (newValue) {
          this.$$('#loadingDialog').opened = true;
        } else {
          this.$$('#loadingDialog').opened = false;
        }
      }

      _convertToBackendObjects() {
        this.articles.forEach(function (article) {
          article.ArticleId = article.Id;
          delete article["Id"];
        });
        this.wheelprotectors.forEach(function (wheelprotector) {
          wheelprotector.WheelprotectorId = wheelprotector.Id;
          delete wheelprotector["Id"];
        });
        this.tires.forEach(function (tire) {
          tire.TireId = tire.Id;
          delete tire["Id"];
        });
        this.frontwheels.forEach(function (frontwheel) {
          frontwheel.FrontWheelId = frontwheel.Id;
          delete frontwheel["Id"];
        });
        this.hoops.forEach(function (hoop) {
          hoop.HoopId = hoop.Id;
          delete hoop["Id"];
        });
        this.wheels.forEach(function (wheel) {
          wheel.WheelId = wheel.Id;
          delete wheel["Id"];
        });
      }
    }
    window.customElements.define(WheelchairConfigPage.is, WheelchairConfigPage);
  </script>
</dom-module>